# How to run a DeFiChain node locally using docker

This guide aims to provide a comprehensive, step-by-step walkthrough for developers interested in running a DeFiChain node locally using docker. By following this guide, you'll be able to set up and run, and interact with a full DeFiChain node.

## Requirements

- AMD64 (x86_64)-based machine (e.g Windows, MacOS, Linux).
- Docker installed and running.
- Basic knowledge of command-line operations.

Step 1: Choose the Right Version

There are various versions of the DeFiChain docker image you can choose from:

- `defi/defichain:latest`: This version points to the latest stable release of DeFiChain. Be careful when upgrading to this version, as it can sometimes be risky.
- `defi/defichain:<version>`: This version points to a specific release of DeFiChain. It uses binaries that have been pre-tested by the DeFiChain Team.

Step 2: Run a node by running the docker image

To run a node open your command line and run `docker run -d defi/defichain` or `docker run -it defi/defichain` to run the docker container in interactive mode, allowing you to intreact with a shell within the container.

These commands start a DeFiChain Mainnet node in a docker container.

After running this command you can view output logs by running `docker logs` or clicking the running image option in the docker desktop app and viewing the Logs tab.

![Sample logs](/Users/swarnabha.sinha/Desktop/1.png)

**What’s in the Docker Image?** The Docker image contains the main package of DeFi Blockchain, which includes the main programs - defid, defi-cli, and defi-tx. These programs are located at /app and are also in the PATH for easy access.

**Data and Configuration** Data is stored at /data. The default configuration file, defi.conf, is located at /data/defi.conf. You can view logs using the docker logs command.

**Ports** The default ports for DeFi Blockchain are 8555 for Mainnet (JSON-RPC - 8554), 18555 for Testnet (JSON-RPC - 18554), and 19555 for Regtest (JSON-RPC - 19554).

## Customization

### Start node with RPC enabled

The following Docker command starts a DeFiChain node in a Docker container configured for local testing (regtest) with RPC access enabled and authenticated for development and testing purposes. `regtest=1` may also be replaced with `testnet=1` to use the testnet instead.

```
> docker run --rm -it defi/defichain \
  defid \
  -printtoconsole \
  -regtest=1 \
  -rpcallowip=172.17.0.0/16 \
  -rpcauth='foo:7d9ba5ae63c3d4dc30583ff4fe65a67e$9e3634e81c11659e3de036d0bf88f89cd169c1039e6e09607562d54765c649cc'
```

[Image of running logs]

### Mount a directory in a volume

To start a DeFiChain node in a Docker container with additional volume mounting for data storage run

```docker run -v ${PWD}/data-dir:/data -it --rm defi/defichain \
  defid \
  -printtoconsole \
  -regtest=1
```

By mounting the `data-dir` directory from the host to the `/data` directory in the container, any data written to `/data` inside the container will be stored in the `data-dir` directory on the host machine. This allows you to persist data between container sessions.

### Create a docker servive

You may create a service using docker compose to set up multiple containers and orchestrate more complex workflows.

```
> defichain:
  image: defi/defichain
  command: >
    defid
    -printtoconsole
    -regtest=1
```

## Using RPC to interact with the daemon

Using RPC (Remote Procedure Call) to interact with the DeFi Blockchain daemon can be done via two main approaches.

The first method involves local authentication using a cookie. If you're running a process on the same computer and user account that started the DeFi Blockchain daemon, it can access the cookie file previously generated by the daemon. However, this method requires access to the local machine.

The second option is to use a username and password for remote procedure calls. This method doesn't require local machine access, but it's recommended to use the newer rpcauth authentication mechanism for security reasons.

### Using Local Authentication with Cookies

First, you need to start the DeFi Blockchain program. You can do this by running the following command:

```
> docker run --rm --name defi-node -it defi/defichain \
  defid \
  -printtoconsole \
  -regtest=1
```

After you’ve started the program, you can ask it for information. You do this by running a query inside the program’s container. Here’s how you do it:

`docker exec defi-node defi-cli -regtest getmintinginfo`

This will give you a result that looks something like this:

```
{
  "blocks": 0,
  "currentblocksize": 0,
  "currentblockweight": 0,
  "currentblocktx": 0,
  "difficulty": 4.656542373906925e-10,
  "errors": "",
  "networkhashps": 0,
  "pooledtx": 0,
  "chain": "regtest"
}
```

Behind the scenes, the `defi-cli` command is getting its information from a file named `.cookie` that’s located in the `/data/regtest/` directory. If you were using this in a real-world setting (not testing), the path wouldn’t include `regtest`.

### Using RPCAuth for remote authentication

To set up remote authentication for the DeFi Blockchain daemon, follow these steps:

#### Step 1: Generate the rpcauth line
Before you can set up remote authentication, you need to create a special line of code called the rpcauth line. This line will hold your login details for the DeFi Blockchain program.

You have two options to generate this line:

You can create it yourself. The format of the line should be `<user>:<salt>$<hash>`, where:

- `<user>` is your desired username.
- `<salt>` is a random string used to enhance security.
- `<hash>` is the hashed password.

Alternatively, you can use the official rpcauth.py script to create the line for you. This script will also give you a random password.

#### Step 2 (Optional): Use the rpcauth.py script

The `rpcauth.py` script is a Python 3 script. You can use it to generate the rpcauth line and a random password. Here’s how you can use the script:

`curl -sSL https://raw.githubusercontent.com/DeFiCh/ain/master/share/rpcauth/rpcauth.py | python3 - <username>`

Replace `<username>` with your chosen username. When you run this command, it will print out the rpcauth line and a random password. You’ll need these for the next step.

***Note***: Each time you run this, you’ll get a new password, even if you use the same username.

The output of the command should look like this:
```
❯ curl -sSL https://raw.githubusercontent.com/DeFiCh/ain/master/share/rpcauth/rpcauth.py | python - <username>

String to be appended to defi.conf:
rpcauth=foo:7d9ba5ae63c3d4dc30583ff4fe65a67e$9e3634e81c11659e3de036d0bf88f89cd169c1039e6e09607562d54765c649cc
Your password:
qDDZdeQ5vw9XXFeVnXT4PZ--tGN2xNjjR4nrtyszZx0=
```

***Note***: If you’re using macOS, you’ll need to use `python3` instead of `python` in the command.

#### Step 3: Use the rpcauth line and password

Now that you have your rpcauth line and password, you can use them to set up remote authentication with the DeFi Blockchain program. You’ll need to add the rpcauth line to your defi.conf file and use the password when you connect to the DeFi Blockchain RPC server.

Step 4: Start the DeFiChain node

Now that you have your login details, you can start the DeFi Blockchain program with the -rpcauth option. Here’s how you do it:

```
docker run --rm --name defi-node -it defi/defichain \
  defid \
  -printtoconsole \
  -regtest=1 \
  -rpcallowip=172.17.0.0/16 \
  -rpcauth='foo:7d9ba5ae63c3d4dc30583ff4fe65a67e$9e3634e81c11659e3de036d0bf88f89cd169c1039e6e09607562d54765c649cc'
```

Alternatively, you could append the line to a defi.conf file and mount it on the container.

A couple of things to note:

- Some shells need you to escape the rpcauth line (like zsh).
- It’s okay to pass the rpcauth line as a command line argument. Even if someone sees it, they won’t be able to get your actual password.

Now you can connect to the DeFi Blockchain RPC server using `defi-cli``. You’ll need to use your username and password when you connect.

To make sure you’re making a remote call, you can start another container to run `defi-cli`` and connect it using the Docker network. Here’s how you do it:

```
docker run -it --link defi-node --rm defi/defichain \
  defi-cli \
  -rpcconnect=defi-node \
  -regtest \
  -rpcuser=foo\
  -stdinrpcpass \
  getbalance
```

Then, enter your password `qDDZdeQ5vw9XXFeVnXT4PZ--tGN2xNjjR4nrtyszZx0=` (generated earlier) and press `Enter`. This command should return the balance of wallet, in this case:

`0.00000000`

And that’s it! You’ve now set up remote authentication.

### Exposing Ports

Depending on the network mode and the runtime flags, several default ports may be available for mapping.

You can map all available ports using `-P` or map individual ports using `-p`. The format for individual port mapping is `-p <hostPort>:<containerPort>`.

This, for example, starts a new Docker container and maps two of its ports to the host machine:

```
docker run --rm -it \
  -p 19554:19554 \
  -p 19555:19555 \
  defi/defichain \
  defid \
  -printtoconsole \
  -regtest=1 \
  -rpcallowip=172.17.0.0/16 \
  -rpcbind=0.0.0.0 \
  -rpcauth='foo:7d9ba5ae63c3d4dc30583ff4fe65a67e$9e3634e81c11659e3de036d0bf88f89cd169c1039e6e09607562d54765c649cc'
```

![Sample output logs](/Users/swarnabha.sinha/Desktop/2.jpeg)

After running the Docker command, you can test if the port mapping worked correctly.

You can do this by sending a JSON-RPC request to the mapped port on the host machine. Here’s the command:

`curl --data-binary '{"jsonrpc":"1.0","id":"1","method":"getnetworkinfo","params":[]}' http://foo:qDDZdeQ5vw9XXFeVnXT4PZ--tGN2xNjjR4nrtyszZx0=@127.0.0.1:19554/`

This command sends a `getnetworkinfo` request to the DeFi Blockchain daemon running in the Docker container. If the port mapping worked correctly, you should receive a response from the daemon.

And that’s it! You’ve successfully exposed ports of a Docker container and tested the port mapping.




